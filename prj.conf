# Console and Shell
CONFIG_SERIAL=y
CONFIG_CONSOLE=y
CONFIG_UART_CONSOLE=y
# Shell: interrupt-driven (stable; avoid Nordic async issues)
CONFIG_SHELL=y
CONFIG_SHELL_BACKEND_SERIAL=y

# RS485 DE: apply patches/0001-shell-uart-rs485-de.patch to Zephyr
CONFIG_SHELL_BACKEND_SERIAL_RS485_DE=y
CONFIG_SHELL_RS485_DE_GPIO_PIN=21
# Delay (ms) before DE low after TX. 3=balance; 4-5=less garbled; 2=faster RX (Enter) but more garbled
CONFIG_SHELL_RS485_DE_OFF_DELAY_MS=1
# Delay (us) after DE high before first byte; fixes "art:~$" -> "uart:~$"
# 減少延遲以加快輸出速度（如果 RS485 線路穩定，可以降低）
CONFIG_SHELL_RS485_DE_ON_DELAY_US=100
# Max DE high (ms); force low after so RX/Enter works
CONFIG_SHELL_RS485_DE_MAX_HIGH_MS=10
CONFIG_SHELL_BACKEND_SERIAL_API_ASYNC=n
CONFIG_SHELL_BACKEND_SERIAL_API_INTERRUPT_DRIVEN=y
CONFIG_UART_INTERRUPT_DRIVEN=y

# Shell init priority lower than UART driver (avoid Hard Fault)
CONFIG_SHELL_BACKEND_SERIAL_INIT_PRIORITY=95

# Shell thread priority (higher priority = lower number, negative for preemptible)
# 設置為 -1 以提高 shell 線程優先級（高於預設的 0）
CONFIG_SHELL_THREAD_PRIORITY=0

CONFIG_SHELL_STACK_SIZE=4096
CONFIG_SHELL_BACKEND_SERIAL_CHECK_DTR=n
# UARTE1 (UART1)
CONFIG_UART_NRFX=y
CONFIG_NRFX_UARTE1=y

# Interrupt-driven; no UART async
# CONFIG_UART_ASYNC_API=y
# CONFIG_UART_1_NRF_HW_ASYNC=y
# CONFIG_UART_1_NRF_HW_ASYNC_TIMER=4
# CONFIG_NRFX_PPI=y

# debug
CONFIG_PRINTK=y
CONFIG_LOG=y
# 讓 Logger 訊息導向 Shell
CONFIG_SHELL_LOG_BACKEND=y
# 設定 Logger 為立即輸出模式（同步，但更直接）
CONFIG_LOG_MODE_IMMEDIATE=y
# 增加日誌緩衝區大小以處理 UWB 模組的大量日誌輸出
CONFIG_LOG_BUFFER_SIZE=65536
# 增加 Shell TX ring buffer 以處理大量輸出（增大以減少阻塞）
CONFIG_SHELL_BACKEND_SERIAL_TX_RING_BUFFER_SIZE=512

# GPIO 和 LED
CONFIG_GPIO=y

# SPI
CONFIG_SPI=y

# 開啟 I2C Shell 指令集
CONFIG_I2C=y
CONFIG_I2C_SHELL=n

#PWM
CONFIG_PWM=y
CONFIG_PWM_NRFX=y

# radio_test
CONFIG_CONSOLE_HANDLER=y
CONFIG_DYNAMIC_INTERRUPTS=y
CONFIG_NRFX_TIMER0=y
CONFIG_NRFX_GPPI=y
CONFIG_CLOCK_CONTROL=y
CONFIG_ENTROPY_GENERATOR=y
CONFIG_NRF_SECURITY=y
# CONFIG_FEM=n (disabled, no FEM hardware)
# CONFIG_FEM_AL_LIB=y (not needed if FEM is disabled)
CONFIG_PICOLIBC_IO_FLOAT=y
CONFIG_SHELL_BACKEND_SERIAL_RX_RING_BUFFER_SIZE=1024

# 11.45 PPM clock
# CONFIG_CLOCK_CONTROL_NRF_K32SRC_SYNTH=y

# dtm
# Use necessary peripherals
CONFIG_NRFX_TIMER0=y
CONFIG_NRFX_TIMER1=y
CONFIG_NRFX_TIMER2=y
CONFIG_NRFX_TIMER3=y
CONFIG_NRFX_GPPI=y
CONFIG_CLOCK_CONTROL=y

CONFIG_FEM_AL_LIB=y
# 需要使用內部 RC 振盪器，不然DTM會有問題
CONFIG_CLOCK_CONTROL_NRF_K32SRC_RC=y

# ==========================================
# mbedTLS 配置 (使用 Zephyr 內建版本)
# ==========================================
# ====================================================
# 1. 關閉 Nordic 專屬的安全層 (關鍵！)
# ====================================================
# 這行是解藥。關閉它，Nordic 就不會去擋 mbedTLS 的原生設定。
CONFIG_NRF_SECURITY=y
CONFIG_MBEDTLS_LEGACY_CRYPTO_C=y

# ====================================================
# 2. 啟用 Zephyr 原生 mbedTLS
# ====================================================
CONFIG_MBEDTLS=y

# GCM 模式 (UWB SE 晶片通訊必備)
CONFIG_MBEDTLS_GCM_C=y

# 亂數產生器 (NXP SDK 需要)
CONFIG_MBEDTLS_CTR_DRBG_C=y
CONFIG_MBEDTLS_HMAC_DRBG_C=y

# Cipher 抽象層
CONFIG_MBEDTLS_CIPHER_C=y

# 大數運算與橢圓曲線 (如果有用到 Key Exchange)
CONFIG_MBEDTLS_ECP_C=y
CONFIG_MBEDTLS_ECP_DP_SECP256R1_ENABLED=y

# 允許從 User Mode 分配 Stack
CONFIG_THREAD_STACK_INFO=y

# 啟用動態執行緒支援
CONFIG_DYNAMIC_THREAD=y

# print mem usage
CONFIG_SYS_HEAP_INFO=n
CONFIG_MAIN_STACK_SIZE=16384
CONFIG_ISR_STACK_SIZE=4096
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4096

# Heap memory pool for k_malloc/k_free
CONFIG_HEAP_MEM_POOL_SIZE=16384

CONFIG_UWB_PRINTK_LOG=y